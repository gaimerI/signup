<!DOCTYPE html>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script

  data-goatcounter="https://todepond.goatcounter.com/count"

  async

  src="//gc.zgo.at/count.js"></script>

<title>Signout - Login</title>

<link rel="shortcut icon" href="/favicon.png" />

<meta property="og:image" content="https://todepond.com/lab/og.png" />

<meta property="og:title" content="Tadi lab" />

<meta name="twitter:card" content="summary_large_image" />

<meta name="twitter:title" content="Tadi lab" />

<meta name="twitter:description" content="" />

<meta name="twitter:image" content="https://todepond.com/lab/og.png" />


<link rel="stylesheet" href="https://gaimeri.github.io/TodePondDotCom/style.css#v2" />

<link rel="stylesheet" href=".https://gaimeri.github.io/TodePondDotCom/style.css#v2" />


<h1>Signup</h1>

<a

  href="https://github.com/TodePond/TodePondDotCom/blob/main/lab/login/"

  style="float: right; position: relative; top: -2px"

  >View source</a

>


<header>

  <label for="username">Public username</label>

  <input type="text" id="username" name="username" autocomplete="off" />

  <br /><br />

  <label for="password">Password</label>

  <input type="password" id="password" name="password" autocomplete="off" />

  <br /><br />

  <button type="submit" class="primary">Login</button>

</header>


<style>

  /* spinning animation */

  @keyframes spin {

    0% {

      transform: rotate(0deg);

    }

    100% {

      transform: rotate(360deg);

    }

  }


  #loading-feed {

    animation: spin 1s linear infinite;

  }

</style>


<h2 id="feed-heading">

  Feed <button id="refresh-sign" class="secondary span">Refreshing...</button>

</h2>

<span

  id="loading-feed"

  style="position: fixed; top: 10px; left: 10px"

  class="secondary"

  >↻</span

>

<main></main>


<script type="module">

  const refreshSign = document.querySelector("#refresh-sign");

  const loadingFeed = document.querySelector("#loading-feed");

  const usernameInput = document.querySelector("#username");

  const passwordInput = document.querySelector("#password");

  const submitButton = document.querySelector("button");


  usernameInput.value = localStorage.getItem("labLoginUsername") ?? "";

  passwordInput.value = localStorage.getItem("labLoginPassword") ?? "";


  async function handleSubmit() {

    if (submitButton.disabled) {

      return;

    }


    usernameInput.value = usernameInput.value.trim();


    const username = usernameInput.value;

    const password = passwordInput.value;


    localStorage.setItem("labLoginUsername", username);

    localStorage.setItem("labLoginPassword", password);


    if (!username || !password) {

      alert("Please fill in both fields");

      return;

    }


    submitButton.disabled = true;

    submitButton.textContent = "Logging in...";


    loadingFeed.style.display = "block";

    const response = await fetch("https://gaimeri17-lablogin.web.val.run", {

      method: "POST",

      body: JSON.stringify({ username, password }),

    });


    const json = await response.json();


    if (json.error) {

      submitButton.disabled = false;

      submitButton.textContent = "Login";

      alert(json.error);

    } else {

      const header = document.querySelector("header");

      const h1 = document.querySelector("h1");

      h1.textContent = `Welcome back, `;

      const namey = document.createElement("span");

      // <span class="name-${username}">${username}</span>!`;

      namey.textContent = username;

      namey.className = `name-${username}`;

      h1.appendChild(namey);

      h1.append("!");

      let html = `

        <label>Status</label>

        <input type="text" id="status" name="status" autocomplete="off" />

        <button id="update-status" class="primary">Update status</button>

        <button id="update-gif">Update status with GIF</button>

        <dialog id="gif-dialog">

          <form method="dialog">

            <header>

              Pick a GIF

              <button type="submit" value="" class="close-button" autofocus>Close</button>

            </header>

            <button class="gif" value="tode" title="Tode"><img src="https://gaimeri.github.io/TodePondDotCom/image/tode.gif" alt="Tode" /></button>

            <button class="gif" value="berd" title="Berd"><img src="https://gaimeri.github.io/TodePondDotCom/image/berd.gif" alt="Berd" /></button>

            <button class="gif" value="bot" title="Bot"><img src="https://gaimeri.github.io/TodePondDotCom/image/bot.gif" alt="Bot" /></button>

          </form>

        </dialog>

        <br /><br />

        <span class="account-dashboard">

          <span class="account-actions">

            <button onclick="location.href = '/lab/login/?logout';" class="">Switch account</button>

            <button id="delete-account" class="danger">Delete account</button>

          </span>

      `;


      const loginAutomatically =

        localStorage.getItem("labLoginAutoLogin") !== "false";

      // if (username === "TodePond") {

      html += `

        <span class="account-settings">

            <label for="logged-in-toggle">

              Login automatically

              <input type="checkbox" id="logged-in-toggle" name="logged-in-toggle" ${

                loginAutomatically ? "checked" : ""

              } />

            </label>

          ${

            username === "TodePond"

              ? `

                <label for="admin-toggle">

                  Admin controls

                  <input type="checkbox" id="admin-toggle" name="admin-toggle" />

                </label>

              `

              : ""

          }

        </span>

      </span>

      `;

      header.innerHTML = html;

      const loggedInToggle = document.querySelector("#logged-in-toggle");

      loggedInToggle.addEventListener("change", () => {

        localStorage.setItem("labLoginAutoLogin", loggedInToggle.checked);

      });

      const adminToggleEnabled =

        localStorage.getItem("labLoginAdmin") === "true";

      const adminToggle = document.querySelector("#admin-toggle");

      if (adminToggle) {

        adminToggle.checked = adminToggleEnabled;

        adminToggle.addEventListener("change", () => {

          localStorage.setItem("labLoginAdmin", adminToggle.checked);

          const actionses = document.querySelectorAll(".actions");

          actionses.forEach(

            (v) =>

              (v.style.display = adminToggle.checked ? "inline-block" : "none")

          );

        });

      }

      // }

      const deleteAccountButton = document.querySelector("#delete-account");

      deleteAccountButton.addEventListener("click", async () => {

        const confirmDelete = confirm(

          "Are you sure you want to delete your account?"

        );

        if (!confirmDelete) {

          return;

        }

        loadingFeed.style.display = "block";

        const response = await fetch(

          "https://gaimeri17-lablogindeleteaccount.web.val.run",

          {

            method: "POST",

            body: JSON.stringify({ username, password }),

          }

        );

        const json = await response.json();

        loadingFeed.style.display = "none";

        if (json.error) {

          alert(json.error);

        } else {

          localStorage.removeItem("labLoginUsername");

          localStorage.removeItem("labLoginPassword");

          location.href = "/lab/login/?delete";

        }

      });

      const statusInput = document.querySelector("#status");

      statusInput.value = json[3];

      const updateStatusButton = document.querySelector("#update-status");

      updateStatusButton.addEventListener("click", () =>

        handleUpdateStatus({ username, password })

      );

      statusInput.addEventListener("keydown", (event) => {

        if (event.key === "Enter") {

          handleUpdateStatus({ username, password });

        }

      });

      const gifDialog = document.querySelector("#gif-dialog");

      document.querySelector("#update-gif").addEventListener("click", () => {

        gifDialog.show();

      });

      gifDialog.addEventListener("close", () => {

        const gif = gifDialog.returnValue;

        if (!gif) return; // close button clicked

        handleUpdateStatus({ username, password, gif });

      });

    }


    await pullUserStatuses();

    loadingFeed.style.display = "none";

  }


  async function handleUpdateStatus({ username, password, gif = null }) {

    const button = document.querySelector("#update-status");

    if (button.disabled) {

      return;

    }

    button.disabled = true;

    loadingFeed.style.display = "block";

    // button.textContent = "Updating status...";

    const statusInput = document.querySelector("#status");

    const status = statusInput.value;

    if (!status) {

      alert("Please fill in the status field");

      return;

    }


    const response = await fetch(

      "https://gaimeri17-labloginupdatestatus.web.val.run",

      {

        method: "POST",

        body: JSON.stringify({ status, username, password, gif }),

      }

    );


    if (response.error) {

      button.disabled = false;

      button.textContent = "Update status";

      alert(response.error);

      return;

    }


    button.disabled = false;

    button.textContent = "Update status";

    loadingFeed.style.display = "block";

    await pullUserStatuses();

    loadingFeed.style.display = "none";

  }


  function handleInputKeyDown(event) {

    if (event.key === "Enter") {

      handleSubmit();

    }

  }


  submitButton.addEventListener("click", handleSubmit);

  usernameInput.addEventListener("keydown", handleInputKeyDown);

  passwordInput.addEventListener("keydown", handleInputKeyDown);

  refreshSign.addEventListener("click", toggleRefresh);


  let nameSet = new Set();


  let refreshTimeout;

  let secondsLeft = 9;

  async function pullUserStatuses() {

    refreshSign.textContent = "Refreshing...";

    secondsLeft = 9;

    if (refreshTimeout !== undefined) {

      clearTimeout(refreshTimeout);

    }

    // https://gaimeri17-lablogingetusers.web.val.run

    const response = await fetch(

      "https://gaimeri17-lablogingetusers.web.val.run"

    );


    const entries = [];


    const json = await response.json();

    for (const user of json) {

      const [status, username, timestamp, gif] = user;

      const isGifValid = /^(tode|berd|bot)$/.test(gif);

      entries.push({

        status,

        username,

        timestamp: new Date(timestamp),

        gif: isGifValid ? gif : undefined,

      });

    }


    const sortedEntries = entries.sort((a, b) => b.timestamp - a.timestamp);


    renderUserStatuses(sortedEntries);


    localStorage.setItem("labLoginUserStatuses", JSON.stringify(sortedEntries));


    const rawUsers = localStorage.getItem("labLoginUserStatuses") ?? "[]";

    let users = [];

    try {

      users = JSON.parse(rawUsers);

    } catch (e) {

      users = [];

    }

    const usernames = users.map((v) => v.username);

    nameSet = new Set(usernames);


    const localRefreshStatus = getLocalRefreshStatus();

    if (localRefreshStatus) {

      refreshSign.textContent = "Auto-refreshing in " + secondsLeft;

      refreshTimeout = setTimeout(handleTimer, 1000);

    } else {

      refreshSign.textContent = "Auto-refresh paused";

    }

  }


  async function handleTimer() {

    secondsLeft--;

    if (secondsLeft === 0) {

      secondsLeft = 9;

      await pullUserStatuses();

      return;

    }


    refreshSign.textContent = "Auto-refreshing in " + secondsLeft;

    if (refreshTimeout !== undefined) {

      clearTimeout(refreshTimeout);

    }


    refreshTimeout = setTimeout(handleTimer, 1000);

  }


  function setRefreshStatus(on) {

    if (on) {

      setLocalRefreshStatus(true);

      refreshSign.textContent = "Auto-refreshing in " + secondsLeft;

      if (!getRefreshStatus()) {

        refreshTimeout = setTimeout(handleTimer, 1000);

      }

    } else {

      setLocalRefreshStatus(false);

      refreshSign.textContent = "Auto-refresh paused";

      if (getRefreshStatus()) {

        clearTimeout(refreshTimeout);

        refreshTimeout = undefined;

      }

